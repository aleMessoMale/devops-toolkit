# Source: https://gist.github.com/2ebbabc3ff515ed27b2e46c0201fb1f8

####################
# Create a Cluster #
####################

# **NB: Parti da altri per avere il clustrer, parti da devops-catalag-code e terraform-eks, aggiungi Ingress in folder helm**
# una volta che hai il cluster con ingress controller, passa a installare Istio (commandline + k8s)

# Install AWS IAM Authenticator: https://github.com/awsdocs/amazon-eks-user-guide/blob/master/doc_source/install-aws-iam-authenticator.md

# Only if you did not yet clone that repository
git clone \
https://github.com/vfarcic/devops-catalog-code.git

cd devops-catalog-code

git pull

cd terraform-eks/simple

# Replace `[...]` with your access key ID`
export AWS_ACCESS_KEY_ID=[...]

# Replace `[...]` with your secret access key
export AWS_SECRET_ACCESS_KEY=[...]

terraform init

terraform apply

export KUBECONFIG=$PWD/kubeconfig

kubectl get nodes

cd ../../../

#################
# Install Istio #
#################

# install istioctl -> 

The istioctl tool is a configuration command line utility that allows service operators to debug and diagnose their Istio service mesh deployments

https://istio.io/latest/docs/ops/diagnostic-tools/istioctl/

Download the latest release with the command:

$ curl -sL https://istio.io/downloadIstioctl | sh -

Add the istioctl client to your path, on a macOS or Linux system:

$ export PATH=$PATH:$HOME/.istioctl/bin

# una volta installato istioctl, procediamo ad installare istio sul cluster
istioctl install --skip-confirmation

# ne esportiamo quindi la variabile di ambiente dove è raggiungibile
export ISTIO_HOSTNAME=$(kubectl \
--namespace istio-system \
get svc istio-ingressgateway \
--output jsonpath="{.status.loadBalancer.ingress[0].hostname}")

export ISTIO_HOST=$(\
dig +short $INGRESS_HOSTNAME)

# io ho ottenuto più valori, ho preso solo il primo host
echo $ISTIO_HOST

# Repeat the `export` commands if the output is empty

# If the output contains more than one IP, wait for a while longer, and repeat the `export` commands.

# If the output continues having more than one IP, choose one of them and execute `export ISTIO_HOST=[...]` with `[...]` being the selected IP.

#######################
# Destroy The Cluster #
#######################

cd devops-catalog-code/terraform-eks/simple

terraform destroy

cd ../../../